<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALISHAN - Advanced Reports & Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --white: #ffffff;
            --body-bg: #f5f7fb;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .logo h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }

        nav ul li a {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
        }

        nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        nav ul li a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        h2 {
            color: var(--dark);
            margin: 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
        }

        /* ================= SEARCH & FILTER STYLES ================= */
        .search-container {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
            width: 100%;
        }

        .search-bar-wrapper {
            position: relative;
            flex: 1;
        }

        .search-bar {
            display: flex;
            width: 100%;
        }

        .search-bar input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid var(--light-gray);
            border-radius: 8px 0 0 8px;
            font-size: 1rem;
            background: var(--white);
            color: var(--dark);
            box-shadow: var(--card-shadow);
        }

        .search-bar input:focus {
            outline: 2px solid var(--primary);
        }

        .search-bar button {
            padding: 0 20px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            transform: translateY(0);
            box-shadow: var(--card-shadow);
        }

        .search-bar button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .show-all-btn {
            padding: 14px 20px;
            background: var(--gray);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            transform: translateY(0);
            box-shadow: var(--card-shadow);
            display: none;
        }

        .show-all-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 5px;
            animation: fadeIn 0.2s ease;
        }

        .suggestion-category {
            padding: 10px 15px;
            background-color: var(--light);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--primary);
            border-bottom: 1px solid var(--light-gray);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--light-gray);
            transition: var(--transition);
            font-size: 14px;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        .suggestion-item.selected {
            background-color: rgba(67, 97, 238, 0.2);
        }

        .suggestion-item i {
            color: var(--gray);
            width: 16px;
            text-align: center;
            font-size: 12px;
        }

        .history-item {
            color: var(--gray);
        }

        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--light);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--primary);
            border-bottom: 1px solid var(--light-gray);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .clear-history-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 3px;
        }

        .clear-history-btn:hover {
            background-color: rgba(247, 37, 133, 0.1);
        }

        .match-highlight {
            background-color: rgba(255, 217, 102, 0.3);
            font-weight: 600;
            padding: 0 2px;
            border-radius: 3px;
        }

        .fuzzy-match {
            opacity: 0.8;
        }

        .analytics-btn {
            padding: 12px;
            background: var(--info);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .analytics-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        /* ================= PAGINATION STYLES ================= */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }

        .page-info {
            font-weight: 600;
            color: var(--primary);
            min-width: 100px;
            text-align: center;
        }

        .page-select {
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            background: var(--white);
            cursor: pointer;
        }

        /* ================= DASHBOARD CARDS ================= */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(67, 97, 238, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary);
        }

        .card-content h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .card-content p {
            color: var(--gray);
            font-size: 14px;
        }

        /* ================= FILTERS ================= */
        .filters {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
        }

        .filter-group select, .filter-group input {
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            width: 100%;
        }

        .btn {
            padding: 10px 20px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--secondary);
        }

        .btn-secondary {
            background: var(--gray);
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #d11466;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* ================= SECTIONS ================= */
        .section {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ================= TABLES ================= */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        th {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            font-weight: 600;
        }

        tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-warning {
            background-color: rgba(248, 150, 30, 0.1);
            color: #f8961e;
        }

        .badge-success {
            background-color: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }

        .badge-danger {
            background-color: rgba(247, 37, 133, 0.1);
            color: #f72585;
        }

        /* ================= CHARTS ================= */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* ================= MODALS ================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
        }

        /* ================= HISTORY ================= */
        .amount-history {
            margin-top: 30px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .history-quality {
            font-weight: 600;
            color: var(--dark);
        }

        .history-date {
            font-size: 14px;
            color: var(--gray);
        }

        .history-notes {
            margin-top: 5px;
            font-size: 14px;
            color: var(--dark);
        }

        .history-amount {
            font-weight: 600;
            color: var(--primary);
            margin-left: 15px;
        }

        .entry-details {
            background-color: rgba(67, 97, 238, 0.05);
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
        }

        .entry-detail {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        /* ================= TABS ================= */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 20px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            margin: 15px 0;
        }

        /* ================= EXPORT BUTTONS ================= */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 8px 15px;
            background: var(--success);
            color: var(--white);
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .export-btn.csv {
            background: var(--info);
        }
        
        .export-btn.excel {
            background: #217346;
        }
        
        /* ================= MODAL FOR EXPORT OPTIONS ================= */
        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .export-modal-content {
            background: var(--white);
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
        
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .export-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-option input {
            width: auto;
        }

        /* ================= NOTIFICATION STYLES ================= */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        
        .notification.success {
            border-left-color: var(--success);
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }
        
        .notification.warning {
            border-left-color: var(--warning);
        }
        
        .notification.info {
            border-left-color: var(--info);
        }
        
        .notification-icon {
            font-size: 1.25rem;
        }
        
        .notification.success .notification-icon {
            color: var(--success);
        }
        
        .notification.error .notification-icon {
            color: var(--danger);
        }
        
        .notification.warning .notification-icon {
            color: var(--warning);
        }
        
        .notification.info .notification-icon {
            color: var(--info);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ================= PENDING CARDS LAYOUT ================= */
        .pending-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .pending-card {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--warning);
        }
        
        .pending-card.received {
            border-left-color: var(--success);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .card-lot {
            font-size: 0.9rem;
            color: var(--gray);
            background: var(--light);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .card-details {
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .detail-label {
            color: var(--gray);
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--dark);
        }
        
        .amount-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-pending {
            background-color: rgba(248, 150, 30, 0.1);
            color: #f8961e;
        }
        
        .badge-received {
            background-color: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }
        
        .progress-container {
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 8px;
            background-color: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--success);
            border-radius: 4px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ================= WEEKLY CARDS LAYOUT ================= */
        .weekly-cards-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-top: 20px;
        }
        
        .week-section {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .week-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .week-total {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .week-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .week-card {
            background: var(--light);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid var(--info);
        }
        
        .week-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .week-card-title {
            font-weight: 600;
            color: var(--dark);
        }
        
        .week-card-date {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .week-card-details {
            font-size: 0.9rem;
        }
        
        .week-card-amount {
            font-weight: 600;
            color: var(--primary);
            margin-top: 5px;
        }

        /* ================= ADVANCED SEARCH SECTION ================= */
        .advanced-search {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }
        
        .search-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .search-toggle h3 {
            color: var(--primary);
            margin: 0;
        }
        
        .search-content {
            display: none;
            margin-top: 15px;
        }
        
        .search-content.active {
            display: block;
        }
        
        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .search-results {
            margin-top: 20px;
        }
        
        .result-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .result-filter-btn {
            padding: 8px 15px;
            background: var(--light);
            border: 1px solid var(--light-gray);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .result-filter-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        /* ================= UNIQUE CODE STYLES ================= */
        .unique-code {
            color: #28a745 !important;
            font-weight: bold;
            background-color: rgba(40, 167, 69, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 8px;
            border: 1px solid #28a745;
            font-family: monospace;
        }

        .datetime {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        /* Modal mein code display ke liye */
        .unique-code-display {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
            margin-top: 10px;
            font-weight: 600;
            font-family: monospace;
        }

        /* ================= AGING REPORT STYLES ================= */
        .aging-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .aging-category {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .aging-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
        }

        .aging-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .aging-fresh .aging-title { color: var(--success); }
        .aging-aging .aging-title { color: var(--warning); }
        .aging-old .aging-title { color: var(--danger); }

        .aging-total {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .aging-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .aging-item:last-child {
            border-bottom: none;
        }

        .aging-item-info {
            flex: 1;
        }

        .aging-item-name {
            font-weight: 600;
            color: var(--dark);
        }

        .aging-item-details {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .aging-item-value {
            font-weight: 600;
            color: var(--primary);
        }

        /* ================= LOADING ANIMATION ================= */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ================= RESPONSIVE STYLES ================= */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                padding: 0 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .history-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .history-amount {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-btn {
                width: 100%;
            }
            
            .pending-cards-container {
                grid-template-columns: 1fr;
            }
            
            .week-cards {
                grid-template-columns: 1fr;
            }
            
            .search-grid {
                grid-template-columns: 1fr;
            }
            
            .result-filters {
                flex-direction: column;
            }

            .card {
                flex-direction: column;
                text-align: center;
            }
            
            .card-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .card-content h3 {
                font-size: 20px;
            }
            
            .section {
                padding: 15px;
            }
            
            .filter-group select, .filter-group input {
                padding: 8px;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .card-actions {
                flex-direction: column;
            }

            .aging-cards-container {
                grid-template-columns: 1fr;
            }
            
            .aging-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 1.5rem;
            }
            
            .card {
                flex-direction: column;
                text-align: center;
            }
            
            .card-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .card-content h3 {
                font-size: 20px;
            }
            
            .section {
                padding: 15px;
            }
            
            .filter-group select, .filter-group input {
                padding: 8px;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .card-actions {
                flex-direction: column;
            }

            .aging-item {
                flex-direction: column;
                gap: 8px;
            }
            
            .aging-item-value {
                align-self: flex-end;
            }
            
            .aging-title {
                font-size: 1.1rem;
            }
            
            .aging-total {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-tshirt logo-icon"></i>
                <h1>ALISHAN</h1>
            </div>
            
            <nav>
                <ul>
                    <li><a href="index.html"><i class="fas fa-home"></i> HOME</a></li>
                    <li><a href="inventory.html"><i class="fas fa-database"></i> INVENTORY</a></li>
                    <li><a href="report.html" class="active"><i class="fas fa-chart-bar"></i> REPORTS</a></li>
                    <li><a href="setting.html"><i class="fas fa-cog"></i> SETTINGS</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <h2><i class="fas fa-chart-bar"></i> Advanced Inventory Reports & Analytics</h2>
        
        <!-- ================= ENHANCED SEARCH SYSTEM ================= -->
        <div class="search-container">
            <div class="search-bar-wrapper">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by quality, lot number, unique code, or color..." onkeyup="handleSearch(event)">
                    <button id="searchBtn" onclick="performSearch()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <ul class="suggestions-dropdown" id="suggestionsList"></ul>
            </div>
            <button class="show-all-btn" id="showAllBtn" style="display: none;" onclick="showAllItems()">
                <i class="fas fa-list"></i> Show All
            </button>
            
            <button class="analytics-btn" onclick="showSearchAnalytics()" title="View Search Analytics">
                <i class="fas fa-chart-bar"></i>
            </button>
        </div>
        
        <!-- Analytics Modal -->
        <div class="modal" id="analyticsModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-chart-line"></i> Search Analytics</h2>
                    <button class="close-btn" onclick="closeModal('analyticsModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="analytics-container" id="analyticsContainer">
                        <!-- Analytics content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ================= DASHBOARD CARDS ================= -->
        <div class="dashboard-cards">
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="card-content">
                    <h3 id="totalValue">₹0</h3>
                    <p>Total Inventory Value</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="card-content">
                    <h3 id="totalItems">0</h3>
                    <p>Total Items in Stock</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="card-content">
                    <h3 id="agingItems">0</h3>
                    <p>Aging Stock (>30 Days)</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div class="card-content">
                    <h3 id="weeklyAdded">0</h3>
                    <p>Added This Week</p>
                </div>
            </div>
            
            <!-- NEW CARDS ADDED -->
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="card-content">
                    <h3 id="receivedAmount">₹0</h3>
                    <p>Total Amount Received</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="card-content">
                    <h3 id="pendingAmount">₹0</h3>
                    <p>Total Pending Amount</p>
                </div>
            </div>
        </div>
        
        <!-- ================= ADVANCED SEARCH SECTION ================= -->
        <div class="advanced-search">
            <div class="search-toggle" onclick="toggleAdvancedSearch()">
                <h3><i class="fas fa-search-plus"></i> Advanced Quality Search</h3>
                <i class="fas fa-chevron-down" id="searchToggleIcon"></i>
            </div>
            
            <div class="search-content" id="advancedSearchContent">
                <div class="search-grid">
                    <div class="filter-group">
                        <label for="qualitySearch">Quality Name</label>
                        <input type="text" id="qualitySearch" placeholder="Enter quality name">
                    </div>
                    
                    <div class="filter-group">
                        <label for="lotNumberSearch">Lot Number</label>
                        <input type="text" id="lotNumberSearch" placeholder="Enter lot number">
                    </div>
                    
                    <div class="filter-group">
                        <label for="uniqueCodeSearch">Unique Code</label>
                        <input type="text" id="uniqueCodeSearch" placeholder="Enter unique code">
                    </div>
                    
                    <div class="filter-group">
                        <label for="amountStatus">Amount Status</label>
                        <select id="amountStatus">
                            <option value="all">All Status</option>
                            <option value="received">Amount Received</option>
                            <option value="pending">Amount Pending</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="dateRange">Date Range</label>
                        <select id="dateRange">
                            <option value="all">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="customDateRange" style="display: none;">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    
                    <div class="filter-group" id="customDateRangeEnd" style="display: none;">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                
                <button class="btn" onclick="performAdvancedSearch()">
                    <i class="fas fa-search"></i> Search Qualities
                </button>
                
                <div class="search-results" id="searchResults">
                    <div class="result-filters">
                        <button class="result-filter-btn active" onclick="filterResults('all', event)">All</button>
                        <button class="result-filter-btn" onclick="filterResults('received', event)">Received</button>
                        <button class="result-filter-btn" onclick="filterResults('pending', event)">Pending</button>
                    </div>
                    
                    <div class="pending-cards-container" id="searchResultsContainer">
                        <p style="text-align: center; color: var(--gray); padding: 40px;">
                            Use the search options above to find quality data
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ================= FILTERS ================= -->
        <div class="filters">
            <div class="filter-group">
                <label for="timePeriod">Time Period</label>
                <select id="timePeriod">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last 365 Days</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="productType">Product Type</label>
                <select id="productType">
                    <option value="all">All Products</option>
                    <option value="bra">Bra</option>
                    <option value="panty">Panty</option>
                    <option value="set">Set</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="qualityFilter">Quality</label>
                <select id="qualityFilter">
                    <option value="all">All Qualities</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
            
            <button class="btn" onclick="applyFilters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="showExportModal()">Export Report</button>
        </div>

        <!-- ================= PAGINATION CONTROLS ================= -->
        <div class="pagination-controls" id="paginationControls" style="display: none;">
            <button class="btn btn-secondary" onclick="prevPage()">
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            
            <span id="pageInfo" class="page-info">Page 1 of 1</span>
            
            <button class="btn btn-secondary" onclick="nextPage()">
                Next <i class="fas fa-chevron-right"></i>
            </button>
            
            <select class="page-select" onchange="changeItemsPerPage(this.value)">
                <option value="10">10 items</option>
                <option value="20">20 items</option>
                <option value="50" selected>50 items</option>
                <option value="100">100 items</option>
            </select>
        </div>

        <!-- ================= TABS ================= -->
        <div class="tabs">
            <div class="tab active" data-tab="pending">Pending Amount Receival</div>
            <div class="tab" data-tab="weekly">Weekly Reports</div>
            <div class="tab" data-tab="history">Amount History</div>
            <div class="tab" data-tab="valuation">Inventory Valuation</div>
            <div class="tab" data-tab="aging">Stock Aging Analysis</div>
        </div>

        <!-- ================= PENDING AMOUNT TAB ================= -->
        <div class="tab-content active" id="pending-tab">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Pending Amount Receival</span>
                    </div>
                    <button class="btn" onclick="showAddAmountModal()">Add Amount Received</button>
                </div>
                
                <div class="pending-cards-container" id="pendingCardsContainer">
                    <!-- Cards will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- ================= WEEKLY REPORTS TAB ================= -->
        <div class="tab-content" id="weekly-tab">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-calendar-week"></i>
                        <span>Weekly Amount Received</span>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label for="weekSelection">Select Week</label>
                    <select id="weekSelection" onchange="loadWeeklyData()">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <div class="weekly-cards-container" id="weeklyCardsContainer">
                    <!-- Weekly cards will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- ================= AMOUNT HISTORY TAB ================= -->
        <div class="tab-content" id="history-tab">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-history"></i>
                        <span>Amount Received History</span>
                    </div>
                </div>
                
                <div class="amount-history" id="amountHistory">
                    <!-- History items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- ================= VALUATION TAB ================= -->
        <div class="tab-content" id="valuation-tab">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i>
                        <span>Inventory Valuation Trend</span>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="valuationTrendChart"></canvas>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-cubes"></i>
                        <span>Stock Summary by Quality</span>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="qualityStockChart"></canvas>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Quality</th>
                                <th>Total Quantity</th>
                                <th>Total Value</th>
                                <th>% of Inventory</th>
                            </tr>
                        </thead>
                        <tbody id="qualityTable">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ================= AGING ANALYSIS TAB ================= -->
        <div class="tab-content" id="aging-tab">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-clock"></i>
                        <span>Inventory Aging Report</span>
                    </div>
                </div>
                
                <div class="aging-cards-container" id="agingCardsContainer">
                    <!-- Aging cards will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- ================= ADD AMOUNT MODAL ================= -->
    <div class="modal" id="addAmountModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Amount Received</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="amountForm">
                <input type="hidden" id="amountInventoryId">
                
                <div class="form-group">
                    <label for="amountQuality">Quality</label>
                    <input type="text" id="amountQuality" readonly>
                </div>
                
                <div class="form-group">
                    <label for="amountLotNumber">Lot Number</label>
                    <input type="text" id="amountLotNumber" readonly>
                </div>
                
                <div class="form-group">
                    <label for="amountUniqueCode">Unique Code</label>
                    <input type="text" id="amountUniqueCode" readonly>
                </div>
                
                <div class="form-group">
                    <label for="amountProductType">Product Type</label>
                    <input type="text" id="amountProductType" readonly>
                </div>
                
                <div class="form-group">
                    <label for="amountExpected">Expected Amount (₹)</label>
                    <input type="text" id="amountExpected" readonly>
                </div>
                
                <div class="form-group">
                    <label for="amountValue">Amount Received (₹)</label>
                    <input type="number" id="amountValue" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="amountDate">Date Received</label>
                    <input type="date" id="amountDate" required>
                </div>
                
                <div class="form-group">
                    <label for="amountNotes">Notes</label>
                    <textarea id="amountNotes" placeholder="Optional notes"></textarea>
                </div>
                
                <button type="submit" class="btn">Save Amount Received</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>

    <!-- ================= EXPORT MODAL ================= -->
    <div class="export-modal" id="exportModal">
        <div class="export-modal-content">
            <div class="modal-header">
                <div class="modal-title">Export Report</div>
                <button class="close-btn" onclick="closeExportModal()">&times;</button>
            </div>
            
            <p>Select the data you want to export:</p>
            
            <div class="export-options">
                <label class="export-option">
                    <input type="checkbox" id="exportPending" checked> Pending Amount Receival
                </label>
                <label class="export-option">
                    <input type="checkbox" id="exportWeekly" checked> Weekly Reports
                </label>
                <label class="export-option">
                    <input type="checkbox" id="exportHistory" checked> Amount History
                </label>
                <label class="export-option">
                    <input type="checkbox" id="exportValuation" checked> Inventory Valuation
                </label>
                <label class="export-option">
                    <input type="checkbox" id="exportAging" checked> Aging Analysis
                </label>
            </div>
            
            <div class="export-buttons">
                <button class="export-btn csv" onclick="exportReport('csv')">
                    <i class="fas fa-file-csv"></i> Export as CSV
                </button>
                <button class="export-btn excel" onclick="exportReport('excel')">
                    <i class="fas fa-file-excel"></i> Export as Excel
                </button>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button class="btn btn-secondary" onclick="showDownloadHelp()" style="font-size: 12px;">
                    <i class="fas fa-question-circle"></i> Where are my downloaded files?
                </button>
            </div>
        </div>
    </div>

    <!-- ================= NOTIFICATION CONTAINER ================= -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // ================= GLOBAL VARIABLES =================
        let inventoryItems = [];
        let amountReceived = [];
        let currentResults = [];
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];
        let searchAnalytics = JSON.parse(localStorage.getItem('searchAnalytics')) || {};
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;
        let searchIndex = {
            byQuality: {},
            byLotNumber: {},
            byNotes: {},
            byProductType: {},
            byUniqueCode: {}
        };
        
        // ================= FILTERING SYSTEM =================
        
        
        
        // Pagination variables
        let currentPage = 1;
        let itemsPerPage = 50;
        let totalPages = 1;
        let searchTimeout = null;
        const SEARCH_DELAY = 300;
        
        
        
        
        
        
        
        
        

        // ================= INITIALIZATION =================
        function initPage() {
            loadData();
            setupEventListeners();
            updateDashboard();
            populateFilters();
            loadPendingAmounts();
            populateWeekSelection();
            loadWeeklyData();
            loadAmountHistory();
            generateValuationTrend();
            generateQualitySummary();
            buildSearchIndex();
            initEnhancedSearch();
            
            // Check for low stock items
            checkLowStock();
        }
        
        // Load data from localStorage
        function loadData() {
            try {
                // Load inventory items
                const inventoryData = localStorage.getItem('inventoryItems');
                inventoryItems = inventoryData ? JSON.parse(inventoryData) : [];
                
                // Load amount received data
                const amountData = localStorage.getItem('amountReceived');
                amountReceived = amountData ? JSON.parse(amountData) : [];
                
                // Data integrity check - remove any amount entries that point to inventory items that no longer exist
                const validInventoryIds = new Set(inventoryItems.map(item => item.id));
                amountReceived = amountReceived.filter(amount => validInventoryIds.has(amount.inventoryId));
                
                // Save the cleaned-up array back to localStorage
                localStorage.setItem('amountReceived', JSON.stringify(amountReceived));
                
                // If no data, add sample data for testing
                if (inventoryItems.length === 0) {
                    inventoryItems = [
                        {
                            id: 1,
                            code: "123456",
                            quality: "Premium Cotton",
                            lotNumber: "LOT001",
                            productType: "Bra",
                            totalDozens: 50,
                            price: 1200,
                            dateTime: "2025-09-01T10:00:00"
                        },
                        {
                            id: 2,
                            code: "654321",
                            quality: "Standard Silk",
                            lotNumber: "LOT002",
                            productType: "Panty",
                            totalDozens: 30,
                            price: 800,
                            dateTime: "2025-08-25T14:30:00"
                        }
                    ];
                    localStorage.setItem('inventoryItems', JSON.stringify(inventoryItems));
                }

                if (amountReceived.length === 0) {
                    amountReceived = [
                        {
                            id: 1,
                            inventoryId: 1,
                            quality: "Premium Cotton",
                            amount: 30000,
                            date: "2025-09-02",
                            notes: "Partial payment received",
                            week: getWeekNumber(new Date("2025-09-02"))
                        }
                    ];
                    localStorage.setItem('amountReceived', JSON.stringify(amountReceived));
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading data. Please check console for details.', 'error');
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('amountForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveAmountReceived();
            });
            
            // Tab functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // If aging tab is clicked, render the aging report
                    if (tabId === 'aging') {
                        renderAgingReport();
                    }
                });
            });
            
            // Date range filter change
            document.getElementById('dateRange').addEventListener('change', function() {
                const customDateRange = document.getElementById('customDateRange');
                const customDateRangeEnd = document.getElementById('customDateRangeEnd');
                
                if (this.value === 'custom') {
                    customDateRange.style.display = 'flex';
                    customDateRangeEnd.style.display = 'flex';
                } else {
                    customDateRange.style.display = 'none';
                    customDateRangeEnd.style.display = 'none';
                }
            });
        }
        
        // ================= ENHANCED SEARCH SYSTEM =================
        function initEnhancedSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const suggestionsList = document.getElementById('suggestionsList');
            if (!suggestionsList) return;
            
            // Event listeners
            searchInput.addEventListener('focus', showSearchHistory);
            searchInput.addEventListener('input', debounce(handleSearchInput, 300));
            searchInput.addEventListener('keydown', handleKeyboardNavigation);
            document.addEventListener('click', closeSuggestionsOnClickOutside);
        }
        
        function buildSearchIndex() {
            searchIndex = {
                qualities: new Set(),
                lotNumbers: new Set(),
                colors: new Set(),
                uniqueCodes: new Set(),
                allItems: []
            };

            inventoryItems.forEach(item => {
                searchIndex.qualities.add(item.quality);
                if (item.lotNumber) searchIndex.lotNumbers.add(item.lotNumber.toString());
                if (item.code) searchIndex.uniqueCodes.add(item.code.toString());
                
                if (item.colors && Array.isArray(item.colors)) {
                    item.colors.forEach(color => {
                        if (typeof color === 'string') {
                            searchIndex.colors.add(color);
                        } else if (color.name) {
                            searchIndex.colors.add(color.name);
                        }
                    });
                }
                searchIndex.allItems.push(item);
            });
        }
        
        function showSearchHistory() {
            const searchInput = document.getElementById('searchInput');
            const suggestionsList = document.getElementById('suggestionsList');
            if (!suggestionsList) return;
            
            if (searchInput.value.length > 0) return;
            
            suggestionsList.innerHTML = '';
            
            if (searchHistory.length === 0) {
                suggestionsList.innerHTML = '<li class="suggestion-item"><i class="fas fa-clock"></i> No search history</li>';
                suggestionsList.style.display = 'block';
                return;
            }
            
            // Add clear history button
            const clearLi = document.createElement('li');
            clearLi.className = 'suggestion-header';
            clearLi.innerHTML = '<span>Recent Searches</span><button onclick="clearSearchHistory()" class="clear-history-btn">Clear</button>';
            suggestionsList.appendChild(clearLi);
            
            // Show recent searches (max 7)
            searchHistory.slice(-7).reverse().forEach((query, index) => {
                const li = document.createElement('li');
                li.className = 'suggestion-item history-item';
                li.innerHTML = `<i class="fas fa-clock"></i> ${query}`;
                li.onclick = () => selectSuggestion(query);
                li.onmouseover = () => setSelectedSuggestion(index);
                suggestionsList.appendChild(li);
            });
            
            suggestionsList.style.display = 'block';
        }
        
        function handleSearchInput(e) {
            const query = e.target.value.toLowerCase().trim();
            const suggestionsList = document.getElementById('suggestionsList');
            if (!suggestionsList) return;
            
            suggestionsList.innerHTML = '';
            selectedSuggestionIndex = -1;
            
            if (query.length === 0) {
                showSearchHistory();
                return;
            }
            
            if (query.length < 2) {
                suggestionsList.style.display = 'none';
                return;
            }
            
            currentSuggestions = generateSuggestions(query);
            displaySuggestions(currentSuggestions, query);
        }
        
        function generateSuggestions(query) {
            const suggestions = [];
            const queryLower = query.toLowerCase();
            
            // Search qualities
            searchIndex.qualities.forEach(quality => {
                if (quality.toLowerCase().includes(queryLower)) {
                    suggestions.push({
                        text: quality,
                        type: 'quality',
                        category: 'Qualities'
                    });
                }
            });
            
            // Search lot numbers
            searchIndex.lotNumbers.forEach(lotNumber => {
                if (lotNumber.includes(query)) {
                    suggestions.push({
                        text: `Lot: ${lotNumber}`,
                        type: 'lot',
                        category: 'Lot Numbers',
                        original: lotNumber
                    });
                }
            });
            
            // Search unique codes
            searchIndex.uniqueCodes.forEach(code => {
                if (code.includes(query)) {
                    suggestions.push({
                        text: `Code: ${code}`,
                        type: 'code',
                        category: 'Unique Codes',
                        original: code
                    });
                }
            });
            
            // Search colors
            searchIndex.colors.forEach(color => {
                if (color.toLowerCase().includes(queryLower)) {
                    suggestions.push({
                        text: `Color: ${color}`,
                        type: 'color',
                        category: 'Colors',
                        original: color
                    });
                }
            });
            
            // Fuzzy search for qualities
            if (suggestions.length < 5) {
                searchIndex.qualities.forEach(quality => {
                    if (fuzzyMatch(quality, queryLower) && !suggestions.some(s => s.text === quality)) {
                        suggestions.push({
                            text: quality,
                            type: 'quality',
                            category: 'Qualities',
                            fuzzy: true
                        });
                    }
                });
            }
            
            // Weight results
            suggestions.sort((a, b) => {
                const weightA = a.type === 'quality' ? 3 : a.type === 'lot' ? 2 : 1;
                const weightB = b.type === 'quality' ? 3 : b.type === 'lot' ? 2 : 1;
                return weightB - weightA;
            });
            
            return suggestions.slice(0, 10);
        }
        
        function displaySuggestions(suggestions, query) {
            const suggestionsList = document.getElementById('suggestionsList');
            if (!suggestionsList) return;
            
            if (suggestions.length === 0) {
                suggestionsList.innerHTML = '<li class="suggestion-item"><i class="fas fa-search"></i> No matches found</li>';
                suggestionsList.style.display = 'block';
                return;
            }
            
            let currentCategory = '';
            
            suggestions.forEach((suggestion, index) => {
                if (suggestion.category !== currentCategory) {
                    currentCategory = suggestion.category;
                    const categoryLi = document.createElement('li');
                    categoryLi.className = 'suggestion-category';
                    categoryLi.textContent = currentCategory;
                    suggestionsList.appendChild(categoryLi);
                }
                
                const li = document.createElement('li');
                li.className = `suggestion-item ${suggestion.fuzzy ? 'fuzzy-match' : ''}`;
                const highlightedText = highlightMatch(suggestion.text, query);
                
                li.innerHTML = `
                    <i class="fas ${suggestion.type === 'quality' ? 'fa-tag' : 
                                  suggestion.type === 'lot' ? 'fa-hashtag' : 
                                  suggestion.type === 'code' ? 'fa-barcode' : 'fa-palette'}"></i>
                    ${highlightedText}
                `;
                
                li.onclick = () => selectSuggestion(suggestion.original || suggestion.text, suggestion.type);
                li.onmouseover = () => setSelectedSuggestion(index);
                suggestionsList.appendChild(li);
            });
            
            suggestionsList.style.display = 'block';
            currentSuggestions = suggestions;
        }
        
        function handleKeyboardNavigation(e) {
            const suggestionsList = document.getElementById('suggestionsList');
            if (!suggestionsList || suggestionsList.style.display !== 'block') return;
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    setSelectedSuggestion(selectedSuggestionIndex + 1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    setSelectedSuggestion(selectedSuggestionIndex - 1);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedSuggestionIndex >= 0) {
                        const selected = currentSuggestions[selectedSuggestionIndex];
                        selectSuggestion(selected.original || selected.text, selected.type);
                    } else {
                        performSearch();
                    }
                    break;
                case 'Escape':
                    suggestionsList.style.display = 'none';
                    selectedSuggestionIndex = -1;
                    break;
            }
        }
        
        function setSelectedSuggestion(index) {
            const items = document.querySelectorAll('#suggestionsList .suggestion-item');
            items.forEach(item => item.classList.remove('selected'));
            
            if (index < 0) index = items.length - 1;
            if (index >= items.length) index = 0;
            
            if (items[index]) {
                items[index].classList.add('selected');
                items[index].scrollIntoView({ block: 'nearest' });
                selectedSuggestionIndex = index;
            }
        }
        
        function selectSuggestion(query, type) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = query;
            addToSearchHistory(query);
            trackSearchAnalytics(query, type);
            
            const suggestionsList = document.getElementById('suggestionsList');
            if (suggestionsList) suggestionsList.style.display = 'none';
            
            selectedSuggestionIndex = -1;
            performSearch();
        }
        
        function addToSearchHistory(query) {
            searchHistory = searchHistory.filter(item => item !== query);
            searchHistory.push(query);
            if (searchHistory.length > 10) searchHistory = searchHistory.slice(-10);
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }
        
        function trackSearchAnalytics(query, type) {
            const now = new Date().toISOString();
            if (!searchAnalytics[query]) {
                searchAnalytics[query] = { count: 0, firstSearched: now, lastSearched: now, type: type };
            }
            searchAnalytics[query].count++;
            searchAnalytics[query].lastSearched = now;
            localStorage.setItem('searchAnalytics', JSON.stringify(searchAnalytics));
        }
        
        function clearSearchHistory() {
            searchHistory = [];
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            showSearchHistory();
        }
        
        function closeSuggestionsOnClickOutside(e) {
            const suggestionsList = document.getElementById('suggestionsList');
            const searchInput = document.getElementById('searchInput');
            if (!suggestionsList || !searchInput) return;
            if (!suggestionsList.contains(e.target) && e.target !== searchInput) {
                suggestionsList.style.display = 'none';
                selectedSuggestionIndex = -1;
            }
        }
        
        function fuzzyMatch(text, query) {
            let searchIndex = 0;
            text = text.toLowerCase();
            for (let i = 0; i < text.length; i++) {
                if (text[i] === query[searchIndex]) searchIndex++;
                if (searchIndex === query.length) return true;
            }
            return false;
        }
        
        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="match-highlight">$1</span>');
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function showSearchAnalytics() {
            const sortedAnalytics = Object.entries(searchAnalytics)
                .sort((a, b) => b[1].count - a[1].count);
            
            let analyticsHTML = `
                <h3><i class="fas fa-chart-line"></i> Top Search Terms</h3>
                <div class="analytics-list">
            `;
            
            sortedAnalytics.forEach(([query, data], index) => {
                if (index < 10) { // Show top 10 only
                    analyticsHTML += `
                        <div class="analytics-item">
                            <div class="analytics-rank">${index + 1}</div>
                            <div class="analytics-query">${query}</div>
                            <div class="analytics-count">${data.count} searches</div>
                            <div class="analytics-type">${data.type}</div>
                        </div>
                    `;
                }
            });
            
            analyticsHTML += `</div>`;
            
            const analyticsContainer = document.getElementById('analyticsContainer');
            if (analyticsContainer) {
                analyticsContainer.innerHTML = analyticsHTML;
            }
            
            // Show modal
            const analyticsModal = document.getElementById('analyticsModal');
            if (analyticsModal) {
                analyticsModal.style.display = 'flex';
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ================= PAGINATION FUNCTIONS =================
        function updatePaginationControls() {
            const paginationControls = document.getElementById('paginationControls');
            const pageInfo = document.getElementById('pageInfo');
            
            if (!paginationControls || !pageInfo) return;
            
            totalPages = Math.ceil(inventoryItems.length / itemsPerPage);
            
            if (inventoryItems.length <= itemsPerPage) {
                paginationControls.style.display = 'none';
            } else {
                paginationControls.style.display = 'flex';
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                displayPaginatedItems();
            }
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayPaginatedItems();
            }
        }
        
        function changeItemsPerPage(value) {
            itemsPerPage = parseInt(value);
            currentPage = 1;
            displayPaginatedItems();
        }
        
        function displayPaginatedItems() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = inventoryItems.slice(start, end);
            
            // In reports, we don't render inventory items directly but update the display
            updateDashboard();
            updatePaginationControls();
        }
        
        // ================= SEARCH FUNCTIONS =================
        function handleSearch(event) {
            if (event.key === 'Enter') {
                // Immediate search on Enter
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                performSearch();
            } else {
                // Debounced search on typing
                searchItems();
            }
        }
        
        function searchItems() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.trim();
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Show loading indicator
            const searchBtn = document.getElementById('searchBtn');
            const originalHtml = searchBtn.innerHTML;
            searchBtn.innerHTML = '<div class="loading-spinner"></div>';
            
            // Set new timeout with debounce
            searchTimeout = setTimeout(() => {
                let filteredItems;
                
                // Use indexes for faster search if term is long enough
                if (searchTerm.length >= 2) {
                    filteredItems = searchWithIndexes(searchTerm);
                } else {
                    // Fallback to regular filter for short terms
                    filteredItems = inventoryItems.filter(item => 
                        (item.quality && item.quality.toLowerCase().includes(searchTerm)) || 
                        (item.lotNumber && item.lotNumber.toLowerCase().includes(searchTerm)) ||
                        (item.notes && item.notes.toLowerCase().includes(searchTerm)) ||
                        (item.cupSize && item.cupSize.toLowerCase().includes(searchTerm)) ||
                        (item.code && item.code.includes(searchTerm))
                    );
                }
                
                // Show result count
                showNotification(`Found ${filteredItems.length} items matching "${searchTerm}"`, 'info');
                
                // Restore search button
                searchBtn.innerHTML = originalHtml;
                
            }, SEARCH_DELAY);
        }
        
        function searchWithIndexes(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            if (!term) return inventoryItems;
            
            const resultIndices = new Set();
            
            // Search in quality index
            Object.keys(searchIndex.byQuality).forEach(quality => {
                if (quality.toLowerCase().includes(term)) {
                    searchIndex.byQuality[quality].forEach(idx => resultIndices.add(idx));
                }
            });
            
            // Search in lot number index
            Object.keys(searchIndex.byLotNumber).forEach(lotNumber => {
                if (lotNumber.toLowerCase().includes(term)) {
                    searchIndex.byLotNumber[lotNumber].forEach(idx => resultIndices.add(idx));
                }
            });
            
            // Search in notes index
            Object.keys(searchIndex.byNotes).forEach(word => {
                if (word.includes(term)) {
                    searchIndex.byNotes[word].forEach(idx => resultIndices.add(idx));
                }
            });
            
            // Search in product type index
            Object.keys(searchIndex.byProductType).forEach(productType => {
                if (productType.toLowerCase().includes(term)) {
                    searchIndex.byProductType[productType].forEach(idx => resultIndices.add(idx));
                }
            });
            
            // Search in unique code index
            Object.keys(searchIndex.byUniqueCode).forEach(code => {
                if (code.includes(term)) {
                    searchIndex.byUniqueCode[code].forEach(idx => resultIndices.add(idx));
                }
            });
            
            // Convert set to array of items
            return Array.from(resultIndices).map(idx => inventoryItems[idx]);
        }
        
        function performSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.trim();
            let filteredItems = [];
            
            // Show loading spinner temporarily
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn) {
                const originalHtml = searchBtn.innerHTML;
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                
                // Reset after delay
                setTimeout(() => {
                    searchBtn.innerHTML = originalHtml;
                }, 1000);
            }
            
            if (!searchTerm) {
                // Show all items if search is empty
                filteredItems = [...inventoryItems];
                showNotification('Showing all inventory items', 'info');
            } else {
                // Perform simple search without indexes
                filteredItems = inventoryItems.filter(item => {
                    const searchTermLower = searchTerm.toLowerCase();
                    return (
                        item.quality && item.quality.toLowerCase().includes(searchTermLower) ||
                        (item.lotNumber && item.lotNumber.toString().includes(searchTerm)) ||
                        (item.notes && item.notes.toLowerCase().includes(searchTermLower)) ||
                        (item.cupSize && item.cupSize.toLowerCase().includes(searchTermLower)) ||
                        (item.code && item.code.includes(searchTerm)) ||
                        // Colors search
                        (item.colors && Array.isArray(item.colors) &&
                            item.colors.some(color =>
                                typeof color === 'string' ?
                                color.toLowerCase().includes(searchTermLower) :
                                (color.name && color.name.toLowerCase().includes(searchTermLower))
                            ))
                    );
                });
                
                showNotification(`Found ${filteredItems.length} items matching "${searchTerm}"`, 'info');
            }
            
            // Hide suggestions
            const suggestionsList = document.getElementById('suggestionsList');
            if (suggestionsList) {
                suggestionsList.style.display = 'none';
            }
            
            // Show the "Show All" button if there's a search term
            const showAllBtn = document.getElementById('showAllBtn');
            if (showAllBtn) {
                showAllBtn.style.display = searchTerm ? 'block' : 'none';
            }
            
            return false; // Prevent form submission
        }
        
        function showAllItems() {
            const searchInput = document.getElementById('searchInput');
            const showAllBtn = document.getElementById('showAllBtn');
            
            if (searchInput) searchInput.value = '';
            if (showAllBtn) showAllBtn.style.display = 'none';
            
            showNotification('Showing all inventory items', 'info');
        }
        
        // ================= DASHBOARD FUNCTIONS =================
        function updateDashboard() {
            // Calculate total inventory value
            const totalValue = inventoryItems.reduce((total, item) => {
                return total + calculateExpectedAmount(item);
            }, 0);
            
            // Count total items
            const totalItems = inventoryItems.length;
            
            // Count aging items (more than 30 days in stock)
            const now = new Date();
            const agingItems = inventoryItems.filter(item => {
                const addedDate = new Date(item.dateTime);
                const daysInStock = Math.floor((now - addedDate) / (1000 * 60 * 60 * 24));
                return daysInStock > 30;
            }).length;
            
            // Count items added this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weeklyAdded = inventoryItems.filter(item => {
                return new Date(item.dateTime) >= oneWeekAgo;
            }).length;
            
            // Calculate total received and pending amounts
            let totalReceived = 0;
            let totalPending = 0;
            
            inventoryItems.forEach(item => {
                const expectedAmount = calculateExpectedAmount(item);
                const receivedAmounts = amountReceived.filter(amount => amount.inventoryId === item.id);
                const totalReceivedForItem = receivedAmounts.reduce((sum, amount) => sum + amount.amount, 0);
                
                totalReceived += totalReceivedForItem;
                totalPending += (expectedAmount - totalReceivedForItem);
            });
            
            // Update dashboard cards
            document.getElementById('totalValue').textContent = '₹' + totalValue.toLocaleString();
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('agingItems').textContent = agingItems;
            document.getElementById('weeklyAdded').textContent = weeklyAdded;
            document.getElementById('receivedAmount').textContent = '₹' + totalReceived.toLocaleString();
            document.getElementById('pendingAmount').textContent = '₹' + totalPending.toLocaleString();
        }
        
        // Helper function to calculate expected amount correctly
        function calculateExpectedAmount(item) {
            // Check if colors array exists and what format it's in
            if (Array.isArray(item.colors) && item.colors.length > 0) {
                
                if (typeof item.colors[0] === 'string') {
                    // SIMPLE FORMAT: Same sizes for all colors
                    // First calculate sum of all sizes
                    let sumOfSizes = 0;
                    const sizes = [28, 30, 32, 34, 36, 38, 40, 42, 44, 46];
                    
                    sizes.forEach(size => {
                        sumOfSizes += item[`size${size}`] || 0;
                    });
                    
                    // Multiply by number of colors and then by price
                    return sumOfSizes * item.colors.length * item.price;
                    
                } else if (typeof item.colors[0] === 'object') {
                    // COMPLEX FORMAT: Different sizes for each color
                    // totalDozens is already correct (includes all colors)
                    return item.totalDozens * item.price;
                }
            }
            
            // Fallback: If no colors or unknown format
            // For same sizes format, we need to calculate manually
            if (item.sizeOption === 'same') {
                let sumOfSizes = 0;
                const sizes = [28, 30, 32, 34, 36, 38, 40, 42, 44, 46];
                
                sizes.forEach(size => {
                    sumOfSizes += item[`size${size}`] || 0;
                });
                
                const numberOfColors = Array.isArray(item.colors) ? item.colors.length : 1;
                return sumOfSizes * numberOfColors * item.price;
            }
            
            return item.totalDozens * item.price;
        }
        
        // ================= ADVANCED SEARCH FUNCTIONS =================
        function toggleAdvancedSearch() {
            const searchContent = document.getElementById('advancedSearchContent');
            const toggleIcon = document.getElementById('searchToggleIcon');
            
            if (searchContent.style.display === 'block') {
                searchContent.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            } else {
                searchContent.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
            }
        }
        
        function filterResults(status, event = null) {
            const filterButtons = document.querySelectorAll('.result-filter-btn');
            
            // Update active button class only if an event is provided
            if (event) {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }
            
            const resultsContainer = document.getElementById('searchResultsContainer');
            resultsContainer.innerHTML = '';
            
            if (currentResults.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No results found</p>';
                return;
            }
            
            let filteredResults = currentResults;
            
            if (status === 'received') {
                filteredResults = currentResults.filter(item => item.amountReceived > 0);
            } else if (status === 'pending') {
                filteredResults = currentResults.filter(item => item.amountReceived === 0);
            }
            
            if (filteredResults.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No results match your filter</p>';
                return;
            }
            
            filteredResults.forEach(item => {
                const card = createPendingCard(item);
                resultsContainer.appendChild(card);
            });
        }
        
        function performAdvancedSearch() {
            const qualitySearch = document.getElementById('qualitySearch').value.toLowerCase();
            const lotNumberSearch = document.getElementById('lotNumberSearch').value.toLowerCase();
            const uniqueCodeSearch = document.getElementById('uniqueCodeSearch').value;
            const amountStatus = document.getElementById('amountStatus').value;
            const dateRange = document.getElementById('dateRange').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const resultsContainer = document.getElementById('searchResultsContainer');
            resultsContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">Searching...</p>';
            
            // Get all inventory items
            let filteredItems = inventoryItems;
            
            // Apply quality filter
            if (qualitySearch) {
                filteredItems = filteredItems.filter(item => 
                    item.quality.toLowerCase().includes(qualitySearch)
                );
            }
            
            // Apply lot number filter
            if (lotNumberSearch) {
                filteredItems = filteredItems.filter(item => 
                    item.lotNumber && item.lotNumber.toLowerCase().includes(lotNumberSearch)
                );
            }
            
            // Apply unique code filter
            if (uniqueCodeSearch) {
                filteredItems = filteredItems.filter(item => 
                    item.code && item.code.includes(uniqueCodeSearch)
                );
            }
            
            // Process each item for search results
            setTimeout(() => {
                currentResults = [];
                
                filteredItems.forEach(item => {
                    // Find amount received for this item
                    const receivedAmounts = amountReceived.filter(amount => 
                        amount.inventoryId === item.id
                    );
                    
                    const totalReceived = receivedAmounts.reduce((sum, amount) => 
                        sum + amount.amount, 0
                    );
                    
                    const expectedAmount = calculateExpectedAmount(item);
                    const pendingAmount = expectedAmount - totalReceived;
                    
                    // Apply date range filter if specified
                    let showItem = true;
                    if (dateRange !== 'all') {
                        const now = new Date();
                        let filteredReceived = receivedAmounts;
                        
                        switch(dateRange) {
                            case 'today':
                                const today = new Date().toDateString();
                                filteredReceived = receivedAmounts.filter(amount => 
                                    new Date(amount.date).toDateString() === today
                                );
                                break;
                            case 'week':
                                const oneWeekAgo = new Date(now.setDate(now.getDate() - 7));
                                filteredReceived = receivedAmounts.filter(amount => 
                                    new Date(amount.date) >= oneWeekAgo
                                );
                                break;
                            case 'month':
                                const oneMonthAgo = new Date(now.setMonth(now.getMonth() - 1));
                                filteredReceived = receivedAmounts.filter(amount => 
                                    new Date(amount.date) >= oneMonthAgo
                                );
                                break;
                            case 'custom':
                                if (startDate && endDate) {
                                    filteredReceived = receivedAmounts.filter(amount => {
                                        const amountDate = new Date(amount.date);
                                        return amountDate >= new Date(startDate) && 
                                               amountDate <= new Date(endDate);
                                    });
                                }
                                break;
                        }
                        
                        const filteredReceivedAmount = filteredReceived.reduce((sum, amount) => 
                            sum + amount.amount, 0
                        );
                        
                        if (amountStatus === 'received') {
                            showItem = filteredReceivedAmount > 0;
                        } else if (amountStatus === 'pending') {
                            showItem = filteredReceivedAmount < expectedAmount;
                        }
                    } else {
                        if (amountStatus === 'received') {
                            showItem = totalReceived > 0;
                        } else if (amountStatus === 'pending') {
                            showItem = totalReceived < expectedAmount;
                        }
                    }
                    
                    if (showItem) {
                        currentResults.push({
                            id: item.id,
                            quality: item.quality,
                            lotNumber: item.lotNumber,
                            code: item.code,
                            productType: item.productType,
                            totalDozens: item.totalDozens,
                            expectedAmount: expectedAmount,
                            amountReceived: totalReceived,
                            pendingAmount: pendingAmount,
                            dateAdded: item.dateTime
                        });
                    }
                });
                
                // Display results
                filterResults('all');
            }, 500);
        }
        
        // ================= PENDING AMOUNTS FUNCTIONS =================
        function createPendingCard(item) {
            const card = document.createElement('div');
            card.className = `pending-card ${item.amountReceived > 0 ? 'received' : ''}`;
            
            const completionPercent = item.expectedAmount > 0 ? 
                Math.round((item.amountReceived / item.expectedAmount) * 100) : 0;
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${item.quality}</div>
                    <div class="card-lot">${item.lotNumber || 'No Lot'} <span class="unique-code">${item.code || ''}</span></div>
                </div>
                
                <div class="card-details">
                    <div class="detail-row">
                        <span class="detail-label">Product Type:</span>
                        <span class="detail-value">${item.productType}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Quantity:</span>
                        <span class="detail-value">${item.totalDozens} dozens</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Expected Amount:</span>
                        <span class="detail-value">₹${item.expectedAmount.toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Received Amount:</span>
                        <span class="detail-value">₹${item.amountReceived.toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Pending Amount:</span>
                        <span class="detail-value">₹${item.pendingAmount.toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${completionPercent}%"></div>
                    </div>
                    <div class="progress-text">
                        <span>0%</span>
                        <span>${completionPercent}% Complete</span>
                        <span>100%</span>
                    </div>
                </div>
                
                <div class="card-actions">
                    <span class="amount-badge ${item.amountReceived > 0 ? 'badge-received' : 'badge-pending'}">
                        ${item.amountReceived > 0 ? 'Received' : 'Pending'}
                    </span>
                    ${item.amountReceived === 0 ? `
                        <button class="btn btn-sm" onclick="addAmountForItem('${item.id}')">
                            Add Amount
                        </button>
                    ` : ''}
                </div>
            `;
            
            return card;
        }
        
        function loadPendingAmounts() {
            const pendingContainer = document.getElementById('pendingCardsContainer');
            pendingContainer.innerHTML = '';
            
            // Get inventory items that don't have amount received entries
            const pendingItems = inventoryItems.filter(item => {
                return !amountReceived.some(amount => amount.inventoryId === item.id);
            });
            
            if (pendingItems.length === 0) {
                pendingContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px; color: var(--success);"></i>
                        <h3>No Pending Amounts</h3>
                        <p>All amounts have been received</p>
                    </div>
                `;
                return;
            }
            
            // Add pending items as cards
            pendingItems.forEach(item => {
                const expectedAmount = calculateExpectedAmount(item);
                
                const cardData = {
                    id: item.id,
                    quality: item.quality,
                    lotNumber: item.lotNumber,
                    code: item.code,
                    productType: item.productType,
                    totalDozens: item.totalDozens,
                    expectedAmount: expectedAmount,
                    amountReceived: 0,
                    pendingAmount: expectedAmount,
                    dateAdded: item.dateTime
                };
                
                const card = createPendingCard(cardData);
                pendingContainer.appendChild(card);
            });
        }
        
        // ================= WEEKLY REPORTS FUNCTIONS =================
        function populateWeekSelection() {
            const weekSelection = document.getElementById('weekSelection');
            weekSelection.innerHTML = '';
            
            // Get unique weeks from amount received data
            const weeks = [...new Set(amountReceived.map(item => {
                const date = new Date(item.date);
                return getWeekNumber(date) + '-' + date.getFullYear();
            }))];
            
            if (weeks.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No data available';
                weekSelection.appendChild(option);
                return;
            }
            
            // Add week options
            weeks.sort().reverse().forEach(week => {
                const [weekNum, year] = week.split('-');
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Week ${weekNum}, ${year}`;
                weekSelection.appendChild(option);
            });
        }
        
        function loadWeeklyData() {
            const weekSelection = document.getElementById('weekSelection');
            const selectedWeek = weekSelection.value;
            
            if (!selectedWeek) return;
            
            const [weekNum, year] = selectedWeek.split('-');
            
            // Filter amount received by selected week
            const weeklyAmounts = amountReceived.filter(item => {
                const date = new Date(item.date);
                return (getWeekNumber(date) == weekNum) && (date.getFullYear() == year);
            });
            
            // Update weekly cards container
            const weeklyContainer = document.getElementById('weeklyCardsContainer');
            weeklyContainer.innerHTML = '';
            
            if (weeklyAmounts.length === 0) {
                weeklyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>No Data Available</h3>
                        <p>No amount received data for selected week</p>
                    </div>
                `;
                return;
            }
            
            // Group by date
            const amountsByDate = {};
            weeklyAmounts.forEach(amount => {
                const date = new Date(amount.date).toDateString();
                if (!amountsByDate[date]) {
                    amountsByDate[date] = [];
                }
                amountsByDate[date].push(amount);
            });
            
            // Create week section
            const weekSection = document.createElement('div');
            weekSection.className = 'week-section';
            
            // Calculate week total
            const weekTotal = weeklyAmounts.reduce((sum, amount) => sum + amount.amount, 0);
            
            weekSection.innerHTML = `
                <div class="week-header">
                    <div class="week-title">Week ${weekNum}, ${year}</div>
                    <div class="week-total">Total: ₹${weekTotal.toLocaleString()}</div>
                </div>
                <div class="week-cards" id="weekCards-${selectedWeek}">
                    <!-- Cards will be added for each date -->
                </div>
            `;
            
            weeklyContainer.appendChild(weekSection);
            
            // Add cards for each date
            const weekCardsContainer = document.getElementById(`weekCards-${selectedWeek}`);
            
            Object.keys(amountsByDate).sort().reverse().forEach(date => {
                const dateAmounts = amountsByDate[date];
                const dateTotal = dateAmounts.reduce((sum, amount) => sum + amount.amount, 0);
                const formattedDate = new Date(date).toLocaleDateString();
                
                dateAmounts.forEach(amount => {
                    const inventoryItem = inventoryItems.find(item => item.id === amount.inventoryId);
                    
                    const card = document.createElement('div');
                    card.className = 'week-card';
                    card.innerHTML = `
                        <div class="week-card-header">
                            <div class="week-card-title">${amount.quality}</div>
                            <div class="week-card-date">${formattedDate}</div>
                        </div>
                        <div class="week-card-details">
                            <div>Lot: ${inventoryItem ? inventoryItem.lotNumber || 'N/A' : 'N/A'} <span class="unique-code">${inventoryItem ? inventoryItem.code || '' : ''}</span></div>
                            <div>Type: ${inventoryItem ? inventoryItem.productType : 'N/A'}</div>
                            <div class="week-card-amount">₹${amount.amount.toLocaleString()}</div>
                        </div>
                    `;
                    
                    weekCardsContainer.appendChild(card);
                });
            });
        }
        
        // ================= AMOUNT HISTORY FUNCTIONS =================
        function loadAmountHistory() {
            const historyContainer = document.getElementById('amountHistory');
            historyContainer.innerHTML = '';
            
            if (amountReceived.length === 0) {
                historyContainer.innerHTML = '<p>No amount received history</p>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedHistory = [...amountReceived].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            // Add history items
            sortedHistory.forEach(amount => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                // Find the inventory item to get details
                const inventoryItem = inventoryItems.find(item => item.id === amount.inventoryId);
                
                historyItem.innerHTML = `
                    <div class="history-info">
                        <div class="history-quality">${amount.quality} ${inventoryItem ? `- ${inventoryItem.lotNumber || 'No Lot'}` : ''} <span class="unique-code">${inventoryItem ? inventoryItem.code || '' : ''}</span></div>
                        <div class="history-date">${new Date(amount.date).toLocaleDateString()} • Week ${getWeekNumber(new Date(amount.date))}</div>
                        ${amount.notes ? `<div class="history-notes">${amount.notes}</div>` : ''}
                        ${inventoryItem ? `
                            <div class="entry-details">
                                <div class="entry-detail"><span>Product Type:</span> <span>${inventoryItem.productType}</span></div>
                                <div class="entry-detail"><span>Quantity:</span> <span>${inventoryItem.totalDozens} dozens</span></div>
                                <div class="entry-detail"><span>Expected Amount:</span> <span>₹${calculateExpectedAmount(inventoryItem).toLocaleString()}</span></div>
                            </div>
                        ` : ''}
                    </div>
                    <div>
                        <div class="history-amount">₹${amount.amount.toLocaleString()}</div>
                        <button class="btn btn-danger btn-sm" onclick="deleteAmountEntry(${amount.id})" style="margin-top: 5px;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                historyContainer.appendChild(historyItem);
            });
        }
        
        // ================= VALUATION FUNCTIONS =================
        function generateValuationTrend() {
            // Group by week and calculate weekly values
            const weeklyValues = {};
            
            inventoryItems.forEach(item => {
                const date = new Date(item.dateTime);
                const weekKey = `${getWeekNumber(date)}-${date.getFullYear()}`;
                
                if (!weeklyValues[weekKey]) {
                    weeklyValues[weekKey] = 0;
                }
                
                weeklyValues[weekKey] += calculateExpectedAmount(item);
            });
            
            // Sort weeks chronologically
            const sortedWeeks = Object.keys(weeklyValues).sort((a, b) => {
                const [aWeek, aYear] = a.split('-');
                const [bWeek, bYear] = b.split('-');
                
                if (aYear !== bYear) return aYear - bYear;
                return aWeek - bWeek;
            });
            
            // Create trend chart
            const trendCtx = document.getElementById('valuationTrendChart').getContext('2d');
            if (window.trendChart) {
                window.trendChart.destroy();
            }
            
            window.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: sortedWeeks.map(wk => `Week ${wk}`),
                    datasets: [{
                        label: 'Inventory Value (₹)',
                        data: sortedWeeks.map(wk => weeklyValues[wk]),
                        fill: false,
                        borderColor: 'rgb(67, 97, 238)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function generateQualitySummary() {
            // Group by quality
            const qualityMap = {};
            inventoryItems.forEach(item => {
                if (!qualityMap[item.quality]) {
                    qualityMap[item.quality] = {
                        quantity: 0,
                        value: 0
                    };
                }
                
                qualityMap[item.quality].quantity += item.totalDozens;
                qualityMap[item.quality].value += calculateExpectedAmount(item);
            });
            
            // Calculate total value
            const totalValue = inventoryItems.reduce((sum, item) => {
                return sum + calculateExpectedAmount(item);
            }, 0);
            
            // Update quality table
            const qualityTable = document.getElementById('qualityTable');
            qualityTable.innerHTML = '';
            
            for (const quality in qualityMap) {
                const percentage = ((qualityMap[quality].value / totalValue) * 100).toFixed(1);
                
                const row = qualityTable.insertRow();
                row.innerHTML = `
                    <td>${quality}</td>
                    <td>${qualityMap[quality].quantity} dozen(s)</td>
                    <td>₹${qualityMap[quality].value.toLocaleString()}</td>
                    <td>${percentage}%</td>
                `;
            }
            
            // Create quality stock chart
            const qualityCtx = document.getElementById('qualityStockChart').getContext('2d');
            if (window.qualityChart) {
                window.qualityChart.destroy();
            }
            
            window.qualityChart = new Chart(qualityCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(qualityMap),
                    datasets: [{
                        label: 'Inventory Value by Quality (₹)',
                        data: Object.values(qualityMap).map(item => item.value),
                        backgroundColor: Object.keys(qualityMap).map((_, i) => 
                            `hsl(${(i * 360) / Object.keys(qualityMap).length}, 70%, 60%)`
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalValue) * 100).toFixed(1);
                                    return `₹${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ================= AGING REPORT FUNCTIONS =================
        function generateAgingReport() {
            const now = new Date();
            const agingData = {
                fresh: { items: [], totalValue: 0 },
                aging: { items: [], totalValue: 0 },
                old: { items: [], totalValue: 0 }
            };

            inventoryItems.forEach(item => {
                const addedDate = new Date(item.dateTime);
                const daysInStock = Math.floor((now - addedDate) / (1000 * 60 * 60 * 24));
                const itemValue = calculateExpectedAmount(item);
                
                if (daysInStock <= 7) {
                    agingData.fresh.items.push({...item, daysInStock});
                    agingData.fresh.totalValue += itemValue;
                } else if (daysInStock <= 30) {
                    agingData.aging.items.push({...item, daysInStock});
                    agingData.aging.totalValue += itemValue;
                } else {
                    agingData.old.items.push({...item, daysInStock});
                    agingData.old.totalValue += itemValue;
                }
            });

            return agingData;
        }
        
        function renderAgingReport() {
            const agingData = generateAgingReport();
            const container = document.getElementById('agingCardsContainer');
            
            container.innerHTML = '';
            
            // Fresh Stock (0-7 days)
            const freshCard = createAgingCategoryCard('fresh', 'Fresh Stock (0-7 days)', agingData.fresh, 'success');
            container.appendChild(freshCard);
            
            // Aging Stock (8-30 days)  
            const agingCard = createAgingCategoryCard('aging', 'Aging Stock (8-30 days)', agingData.aging, 'warning');
            container.appendChild(agingCard);
            
            // Old Stock (30+ days)
            const oldCard = createAgingCategoryCard('old', 'Old Stock (30+ days)', agingData.old, 'danger');
            container.appendChild(oldCard);
        }
        
        function createAgingCategoryCard(type, title, data, colorClass) {
            const card = document.createElement('div');
            card.className = `aging-category aging-${type}`;
            
            card.innerHTML = `
                <div class="aging-header">
                    <div class="aging-title">
                        <i class="fas fa-${type === 'fresh' ? 'leaf' : type === 'aging' ? 'clock' : 'calendar-times'}"></i>
                        ${title}
                    </div>
                    <div class="aging-total">₹${data.totalValue.toLocaleString()}</div>
                </div>
                <div class="aging-items">
                    ${data.items.length === 0 ? 
                        '<p style="text-align: center; color: var(--gray); padding: 20px;">No items in this category</p>' : 
                        data.items.map(item => `
                            <div class="aging-item">
                                <div class="aging-item-info">
                                    <div class="aging-item-name">${item.quality} <span class="unique-code">${item.code || ''}</span></div>
                                    <div class="aging-item-details">
                                        ${item.lotNumber || 'No Lot'} • ${item.daysInStock} days • ${item.totalDozens} dozens
                                    </div>
                                </div>
                                <div class="aging-item-value">₹${calculateExpectedAmount(item).toLocaleString()}</div>
                            </div>
                        `).join('')
                    }
                </div>
            `;
            
            return card;
        }
        
        // ================= LOW STOCK ALERT FUNCTION =================
        function checkLowStock() {
            const lowStockItems = inventoryItems.filter(item => item.totalDozens < 10);
            
            if (lowStockItems.length > 0) {
                const message = `Low stock alert: ${lowStockItems.length} items have less than 10 dozens`;
                showNotification(message, 'warning');
                
                // Console mein bhi log karein for debugging
                console.log('Low stock items:', lowStockItems);
            }
            
            return lowStockItems;
        }
        
        // ================= AMOUNT RECEIVED FUNCTIONS =================
        function showAddAmountModal() {
            const modal = document.getElementById('addAmountModal');
            
            // Reset form
            document.getElementById('amountForm').reset();
            document.getElementById('amountInventoryId').value = '';
            document.getElementById('amountQuality').value = '';
            document.getElementById('amountLotNumber').value = '';
            document.getElementById('amountUniqueCode').value = '';
            document.getElementById('amountProductType').value = '';
            document.getElementById('amountExpected').value = '';
            
            // Set today's date as default
            document.getElementById('amountDate').valueAsDate = new Date();
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        function addAmountForItem(inventoryId) {
            const modal = document.getElementById('addAmountModal');
            const inventoryItem = inventoryItems.find(item => item.id === parseInt(inventoryId));
            
            if (!inventoryItem) {
                showNotification('Inventory item not found!', 'error');
                return;
            }
            
            // Set form values
            document.getElementById('amountInventoryId').value = inventoryItem.id;
            document.getElementById('amountQuality').value = inventoryItem.quality;
            document.getElementById('amountLotNumber').value = inventoryItem.lotNumber || 'N/A';
            document.getElementById('amountUniqueCode').value = inventoryItem.code || 'N/A';
            document.getElementById('amountProductType').value = inventoryItem.productType;
            
            // Calculate expected amount
            const expectedAmount = calculateExpectedAmount(inventoryItem);
            document.getElementById('amountExpected').value = expectedAmount.toLocaleString();
            
            // Set the amount value to the expected amount
            document.getElementById('amountValue').value = expectedAmount;
            
            // Set today's date as default
            document.getElementById('amountDate').valueAsDate = new Date();
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('addAmountModal').style.display = 'none';
        }
        
        function saveAmountReceived() {
            const inventoryId = document.getElementById('amountInventoryId').value;
            const quality = document.getElementById('amountQuality').value;
            const amount = parseFloat(document.getElementById('amountValue').value);
            const date = document.getElementById('amountDate').value;
            const notes = document.getElementById('amountNotes').value;
            
            if (!inventoryId || isNaN(amount) || !date) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Create new amount received entry
            const newAmount = {
                id: Date.now(),
                inventoryId: parseInt(inventoryId),
                quality: quality,
                amount: amount,
                date: date,
                notes: notes,
                week: getWeekNumber(new Date(date))
            };
            
            // Add to array
            amountReceived.push(newAmount);
            
            // Save to localStorage
            localStorage.setItem('amountReceived', JSON.stringify(amountReceived));
            
            // Close modal
            closeModal();
            
            // Refresh data
            loadPendingAmounts();
            populateWeekSelection();
            loadWeeklyData();
            loadAmountHistory();
            
            showNotification('Amount received saved successfully!', 'success');
        }
        
        function deleteAmountEntry(amountId) {
            if (!confirm('Are you sure you want to delete this amount entry? This action cannot be undone.')) {
                return;
            }
            
            // Find index of amount entry
            const index = amountReceived.findIndex(item => item.id === amountId);
            
            if (index === -1) {
                showNotification('Amount entry not found!', 'error');
                return;
            }
            
            // Remove from array
            amountReceived.splice(index, 1);
            
            // Save to localStorage
            localStorage.setItem('amountReceived', JSON.stringify(amountReceived));
            
            // Refresh data
            loadPendingAmounts();
            loadWeeklyData();
            loadAmountHistory();
            
            showNotification('Amount entry deleted successfully!', 'success');
        }
        
        // ================= FILTER FUNCTIONS =================
        
        
        
    // ================= FILTERING SYSTEM =================
    let currentFilteredItems = [];
    let activeFilters = {
        timePeriod: '7',
        productType: 'all',
        quality: 'all'
    };

    // Initialize filters
    function populateFilters() {
        const qualityFilter = document.getElementById('qualityFilter');
        
        // Clear existing options (except the default "All Qualities")
        qualityFilter.innerHTML = '<option value="all">All Qualities</option>';
        
        // Get unique qualities from inventory items
        const qualities = [...new Set(inventoryItems.map(item => item.quality))];
        
        // Add quality options to the dropdown
        qualities.forEach(quality => {
            const option = document.createElement('option');
            option.value = quality;
            option.textContent = quality;
            qualityFilter.appendChild(option);
        });
        
        // Set up event listeners for filters
        document.getElementById('timePeriod').addEventListener('change', function() {
            activeFilters.timePeriod = this.value;
            applyFilters();
        });
        
        document.getElementById('productType').addEventListener('change', function() {
            activeFilters.productType = this.value;
            applyFilters();
        });
        
        document.getElementById('qualityFilter').addEventListener('change', function() {
            activeFilters.quality = this.value;
            applyFilters();
        });
    }

    // Apply filters function
    function applyFilters() {
        console.log('Applying filters:', activeFilters);
        
        // Start with all inventory items
        currentFilteredItems = [...inventoryItems];
        
        // Apply time period filter
        if (activeFilters.timePeriod !== 'all') {
            const days = parseInt(activeFilters.timePeriod);
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            
            currentFilteredItems = currentFilteredItems.filter(item => {
                const itemDate = new Date(item.dateTime);
                return itemDate >= cutoffDate;
            });
        }
        
        // Apply product type filter
        if (activeFilters.productType !== 'all') {
            currentFilteredItems = currentFilteredItems.filter(item => 
                item.productType.toLowerCase() === activeFilters.productType.toLowerCase()
            );
        }
        
        // Apply quality filter
        if (activeFilters.quality !== 'all') {
            currentFilteredItems = currentFilteredItems.filter(item => 
                item.quality === activeFilters.quality
            );
        }
        
        // Update UI with filtered results
        updateFilteredResults();
        
        showNotification(`Found ${currentFilteredItems.length} items matching your filters`, 'success');
    }

    // Update UI with filtered results
    function updateFilteredResults() {
        // Update dashboard with filtered data
        updateDashboardWithFilteredData();
        
        // Update pending amounts tab
        updatePendingAmountsTab();
        
        // Update other tabs as needed
        // updateWeeklyTab();
        // updateHistoryTab();
        // updateValuationTab();
        // updateAgingTab();
    }

    // Update dashboard with filtered data
    function updateDashboardWithFilteredData() {
        // Calculate total inventory value from filtered items
        const totalValue = currentFilteredItems.reduce((total, item) => {
            return total + calculateExpectedAmount(item);
        }, 0);
        
        // Count total filtered items
        const totalItems = currentFilteredItems.length;
        
        // Count aging items (more than 30 days in stock) from filtered items
        const now = new Date();
        const agingItems = currentFilteredItems.filter(item => {
            const addedDate = new Date(item.dateTime);
            const daysInStock = Math.floor((now - addedDate) / (1000 * 60 * 60 * 24));
            return daysInStock > 30;
        }).length;
        
        // Count items added this week from filtered items
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const weeklyAdded = currentFilteredItems.filter(item => {
            return new Date(item.dateTime) >= oneWeekAgo;
        }).length;
        
        // Calculate total received and pending amounts from filtered items
        let totalReceived = 0;
        let totalPending = 0;
        
        currentFilteredItems.forEach(item => {
            const expectedAmount = calculateExpectedAmount(item);
            const receivedAmounts = amountReceived.filter(amount => amount.inventoryId === item.id);
            const totalReceivedForItem = receivedAmounts.reduce((sum, amount) => sum + amount.amount, 0);
            
            totalReceived += totalReceivedForItem;
            totalPending += (expectedAmount - totalReceivedForItem);
        });
        
        // Update dashboard cards with filtered data
        document.getElementById('totalValue').textContent = '₹' + totalValue.toLocaleString();
        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('agingItems').textContent = agingItems;
        document.getElementById('weeklyAdded').textContent = weeklyAdded;
        document.getElementById('receivedAmount').textContent = '₹' + totalReceived.toLocaleString();
        document.getElementById('pendingAmount').textContent = '₹' + totalPending.toLocaleString();
    }

    // Update pending amounts tab with filtered data
    function updatePendingAmountsTab() {
        const pendingContainer = document.getElementById('pendingCardsContainer');
        pendingContainer.innerHTML = '';
        
        // Get inventory items that don't have amount received entries FROM FILTERED ITEMS
        const pendingItems = currentFilteredItems.filter(item => {
            return !amountReceived.some(amount => amount.inventoryId === item.id);
        });
        
        if (pendingItems.length === 0) {
            pendingContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px; color: var(--success);"></i>
                    <h3>No Pending Amounts</h3>
                    <p>All amounts have been received</p>
                </div>
            `;
            return;
        }
        
        // Add pending items as cards
        pendingItems.forEach(item => {
            const expectedAmount = calculateExpectedAmount(item);
            
            const cardData = {
                id: item.id,
                quality: item.quality,
                lotNumber: item.lotNumber,
                code: item.code,
                productType: item.productType,
                totalDozens: item.totalDozens,
                expectedAmount: expectedAmount,
                amountReceived: 0,
                pendingAmount: expectedAmount,
                dateAdded: item.dateTime
            };
            
            const card = createPendingCard(cardData);
            pendingContainer.appendChild(card);
        });
    }

    // Clear all filters
    function clearFilters() {
        // Reset filter values
        document.getElementById('timePeriod').value = '7';
        document.getElementById('productType').value = 'all';
        document.getElementById('qualityFilter').value = 'all';
        
        // Reset active filters
        activeFilters = {
            timePeriod: '7',
            productType: 'all',
            quality: 'all'
        };
        
        // Show all items
        currentFilteredItems = [...inventoryItems];
        updateFilteredResults();
        
        showNotification('Filters cleared successfully', 'success');
    }

    // ================= ENHANCED SEARCH WITH FILTERING =================
    function performSearch() {
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) return;
        
        const searchTerm = searchInput.value.trim();
        
        // Hide suggestions
        const suggestionsList = document.getElementById('suggestionsList');
        if (suggestionsList) {
            suggestionsList.style.display = 'none';
        }
        
        if (!searchTerm) {
            // If search is empty, apply current filters
            applyFilters();
            showNotification('Showing all inventory items', 'info');
            return;
        }
        
        // Perform search within filtered items (or all items if no filters applied)
        const searchBase = currentFilteredItems.length > 0 ? currentFilteredItems : inventoryItems;
        const searchTermLower = searchTerm.toLowerCase();
        
        const searchResults = searchBase.filter(item => {
            return (
                item.quality && item.quality.toLowerCase().includes(searchTermLower) ||
                (item.lotNumber && item.lotNumber.toString().includes(searchTerm)) ||
                (item.notes && item.notes.toLowerCase().includes(searchTermLower)) ||
                (item.cupSize && item.cupSize.toLowerCase().includes(searchTermLower)) ||
                (item.code && item.code.includes(searchTerm)) ||
                // Colors search
                (item.colors && Array.isArray(item.colors) &&
                    item.colors.some(color =>
                        typeof color === 'string' ?
                        color.toLowerCase().includes(searchTermLower) :
                        (color.name && color.name.toLowerCase().includes(searchTermLower))
                    ))
            );
        });
        
        // Temporarily show search results
        showSearchResultsInUI(searchResults, searchTerm);
        
        showNotification(`Found ${searchResults.length} items matching "${searchTerm}"`, 'info');
    }

    // Show search results in UI
    function showSearchResultsInUI(results, searchTerm) {
        // You can implement this based on which tab is active
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
            const tabName = activeTab.getAttribute('data-tab');
            
            switch(tabName) {
                case 'pending':
                    showSearchResultsInPendingTab(results, searchTerm);
                    break;
                case 'weekly':
                    showSearchResultsInWeeklyTab(results, searchTerm);
                    break;
                // Add cases for other tabs as needed
                default:
                    showGenericSearchResults(results, searchTerm);
            }
        } else {
            showGenericSearchResults(results, searchTerm);
        }
    }

    // Show search results in pending tab
    function showSearchResultsInPendingTab(results, searchTerm) {
        const pendingContainer = document.getElementById('pendingCardsContainer');
        pendingContainer.innerHTML = '';
        
        if (results.length === 0) {
            pendingContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>No Results Found</h3>
                    <p>No items matching "${searchTerm}"</p>
                </div>
            `;
            return;
        }
        
        // Highlight search term in results
        results.forEach(item => {
            const expectedAmount = calculateExpectedAmount(item);
            const receivedAmounts = amountReceived.filter(amount => amount.inventoryId === item.id);
            const totalReceived = receivedAmounts.reduce((sum, amount) => sum + amount.amount, 0);
            const pendingAmount = expectedAmount - totalReceived;
            
            const cardData = {
                id: item.id,
                quality: highlightSearchTerm(item.quality, searchTerm),
                lotNumber: highlightSearchTerm(item.lotNumber || 'N/A', searchTerm),
                code: item.code || 'N/A',
                productType: item.productType,
                totalDozens: item.totalDozens,
                expectedAmount: expectedAmount,
                amountReceived: totalReceived,
                pendingAmount: pendingAmount,
                dateAdded: item.dateTime
            };
            
            const card = createPendingCard(cardData);
            pendingContainer.appendChild(card);
        });
    }

    // Highlight search term in text
    function highlightSearchTerm(text, searchTerm) {
        if (!text || !searchTerm) return text;
        
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        return text.toString().replace(regex, '<mark>$1</mark>');
    }

    // Initialize the page when loaded
    document.addEventListener('DOMContentLoaded', function() {
        initPage();
        
        // Apply initial filters
        setTimeout(() => {
            applyFilters();
        }, 500);
    });

        
        
        
        
        
        
        
        
        // ================= EXPORT FUNCTIONS =================
        function showExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }
        
        function exportReport(format) {
            // Get selected export options
            const exportPending = document.getElementById('exportPending').checked;
            const exportWeekly = document.getElementById('exportWeekly').checked;
            const exportHistory = document.getElementById('exportHistory').checked;
            const exportValuation = document.getElementById('exportValuation').checked;
            const exportAging = document.getElementById('exportAging').checked;
            
            // Check if at least one option is selected
            if (!exportPending && !exportWeekly && !exportHistory && !exportValuation && !exportAging) {
                showNotification('Please select at least one data type to export', 'error');
                return;
            }
            
            // Create a workbook
            const wb = XLSX.utils.book_new();
            let hasData = false;
            
            // Add selected sheets to the workbook
            if (exportPending) {
                const pendingData = getPendingAmountData();
                if (pendingData.length > 0) {
                    const wsPending = XLSX.utils.json_to_sheet(pendingData);
                    XLSX.utils.book_append_sheet(wb, wsPending, "Pending Amounts");
                    hasData = true;
                }
            }
            
            if (exportWeekly) {
                const weeklyData = getWeeklyReportData();
                if (weeklyData.length > 0) {
                    const wsWeekly = XLSX.utils.json_to_sheet(weeklyData);
                    XLSX.utils.book_append_sheet(wb, wsWeekly, "Weekly Reports");
                    hasData = true;
                }
            }
            
            if (exportHistory) {
                const historyData = getAmountHistoryData();
                if (historyData.length > 0) {
                    const wsHistory = XLSX.utils.json_to_sheet(historyData);
                    XLSX.utils.book_append_sheet(wb, wsHistory, "Amount History");
                    hasData = true;
                }
            }
            
            if (exportValuation) {
                const valuationData = getValuationData();
                if (valuationData.length > 0) {
                    const wsValuation = XLSX.utils.json_to_sheet(valuationData);
                    XLSX.utils.book_append_sheet(wb, wsValuation, "Inventory Valuation");
                    hasData = true;
                }
            }
            
            if (exportAging) {
                const agingData = getAgingData();
                if (agingData.length > 0) {
                    const wsAging = XLSX.utils.json_to_sheet(agingData);
                    XLSX.utils.book_append_sheet(wb, wsAging, "Aging Analysis");
                    hasData = true;
                }
            }
            
            // Check if any data was added to the workbook
            if (!hasData) {
                showNotification('No data available for export', 'error');
                return;
            }
            
            // Generate file name with current date and time
            const date = new Date();
            const dateStr = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
            const timeStr = `${date.getHours()}-${date.getMinutes()}`;
            const fileName = `ALISHAN_Report_${dateStr}_${timeStr}.${format === 'csv' ? 'csv' : 'xlsx'}`;
            
            // Export the workbook
            try {
                if (format === 'csv') {
                    // For CSV, we'll export the first sheet only
                    const firstSheetName = wb.SheetNames[0];
                    if (firstSheetName) {
                        const csv = XLSX.utils.sheet_to_csv(wb.Sheets[firstSheetName]);
                        downloadFile(csv, fileName, 'text/csv');
                    }
                } else {
                    XLSX.writeFile(wb, fileName);
                }
                
                // Show success message with download info
                showNotification(`Report exported successfully! File: ${fileName}`, 'success');
                
                // Close the modal
                closeExportModal();
                
                // Show download location info
                setTimeout(() => {
                    showNotification('Check your Downloads folder for the exported file', 'info', 5000);
                }, 1000);
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error exporting report. Please try again.', 'error');
            }
        }
        
        // Get pending amount data for export
        function getPendingAmountData() {
            const pendingItems = inventoryItems.filter(item => {
                return !amountReceived.some(amount => amount.inventoryId === item.id);
            });
            
            return pendingItems.map(item => {
                const addedDate = new Date(item.dateTime);
                const daysInStock = Math.floor((new Date() - addedDate) / (1000 * 60 * 60 * 24));
                const expectedAmount = calculateExpectedAmount(item);
                
                return {
                    'Date Added': addedDate.toLocaleDateString(),
                    'Quality': item.quality,
                    'Unique Code': item.code || 'N/A',
                    'Lot Number': item.lotNumber || 'N/A',
                    'Product Type': item.productType,
                    'Quantity (Dozens)': item.totalDozens,
                    'Expected Amount (₹)': expectedAmount,
                    'Days in Stock': daysInStock,
                    'Status': 'Pending'
                };
            });
        }
        
        // Get weekly report data for export
        function getWeeklyReportData() {
            const weeklyData = [];
            
            // Get all weeks from amount received data
            const weeks = [...new Set(amountReceived.map(item => {
                const date = new Date(item.date);
                return getWeekNumber(date) + '-' + date.getFullYear();
            }))];
            
            weeks.forEach(week => {
                const [weekNum, year] = week.split('-');
                const weeklyAmounts = amountReceived.filter(item => {
                    const date = new Date(item.date);
                    return (getWeekNumber(date) == weekNum) && (date.getFullYear() == year);
                });
                
                // Group by date for this week
                const amountsByDate = {};
                weeklyAmounts.forEach(amount => {
                    const date = new Date(amount.date).toDateString();
                    if (!amountsByDate[date]) {
                        amountsByDate[date] = [];
                    }
                    amountsByDate[date].push(amount);
                });
                
                // Add to weekly data
                Object.keys(amountsByDate).forEach(date => {
                    const dateTotal = amountsByDate[date].reduce((sum, amount) => sum + amount.amount, 0);
                    
                    weeklyData.push({
                        'Week': `Week ${weekNum}, ${year}`,
                        'Date': new Date(date).toLocaleDateString(),
                        'Total Amount (₹)': dateTotal,
                        'Records Count': amountsByDate[date].length
                    });
                    
                    // Add individual records
                    amountsByDate[date].forEach(amount => {
                        const inventoryItem = inventoryItems.find(item => item.id === amount.inventoryId);
                        
                        weeklyData.push({
                            'Week': '',
                            'Date': '',
                            'Quality': amount.quality,
                            'Unique Code': inventoryItem ? inventoryItem.code || 'N/A' : 'N/A',
                            'Lot Number': inventoryItem ? inventoryItem.lotNumber || 'N/A' : 'N/A',
                            'Amount (₹)': amount.amount,
                            'Product Type': inventoryItem ? inventoryItem.productType : 'N/A'
                        });
                    });
                });
            });
            
            return weeklyData;
        }
        
        // Get amount history data for export
        function getAmountHistoryData() {
            return amountReceived.map(amount => {
                const inventoryItem = inventoryItems.find(item => item.id === amount.inventoryId);
                
                return {
                    'Date Received': new Date(amount.date).toLocaleDateString(),
                    'Week': `Week ${getWeekNumber(new Date(amount.date))}`,
                    'Quality': amount.quality,
                    'Unique Code': inventoryItem ? inventoryItem.code || 'N/A' : 'N/A',
                    'Lot Number': inventoryItem ? inventoryItem.lotNumber || 'N/A' : 'N/A',
                    'Amount Received (₹)': amount.amount,
                    'Product Type': inventoryItem ? inventoryItem.productType : 'N/A',
                    'Quantity (Dozens)': inventoryItem ? inventoryItem.totalDozens : 'N/A',
                    'Expected Amount (₹)': inventoryItem ? calculateExpectedAmount(inventoryItem) : 'N/A',
                    'Notes': amount.notes || 'N/A'
                };
            });
        }
        
        // Get valuation data for export
        function getValuationData() {
            const valuationData = [];
            
            // Group by quality
            const qualityMap = {};
            inventoryItems.forEach(item => {
                if (!qualityMap[item.quality]) {
                    qualityMap[item.quality] = {
                        quantity: 0,
                        value: 0
                    };
                }
                
                qualityMap[item.quality].quantity += item.totalDozens;
                qualityMap[item.quality].value += calculateExpectedAmount(item);
            });
            
            // Calculate total value
            const totalValue = inventoryItems.reduce((sum, item) => {
                return sum + calculateExpectedAmount(item);
            }, 0);
            
            // Add quality data
            for (const quality in qualityMap) {
                const percentage = ((qualityMap[quality].value / totalValue) * 100).toFixed(1);
                
                valuationData.push({
                    'Quality': quality,
                    'Total Quantity (Dozens)': qualityMap[quality].quantity,
                    'Total Value (₹)': qualityMap[quality].value,
                    'Percentage of Inventory': `${percentage}%`
                });
            }
            
            // Add total row
            valuationData.push({
                'Quality': 'TOTAL',
                'Total Quantity (Dozens)': inventoryItems.reduce((sum, item) => sum + item.totalDozens, 0),
                'Total Value (₹)': totalValue,
                'Percentage of Inventory': '100%'
            });
            
            return valuationData;
        }
        
        // Get aging data for export
        function getAgingData() {
            const agingData = generateAgingReport();
            const exportData = [];
            
            // Add fresh stock
            agingData.fresh.items.forEach(item => {
                exportData.push({
                    'Category': 'Fresh Stock (0-7 days)',
                    'Quality': item.quality,
                    'Unique Code': item.code || 'N/A',
                    'Lot Number': item.lotNumber || 'N/A',
                    'Days in Stock': item.daysInStock,
                    'Quantity (Dozens)': item.totalDozens,
                    'Value (₹)': calculateExpectedAmount(item)
                });
            });
            
            // Add aging stock
            agingData.aging.items.forEach(item => {
                exportData.push({
                    'Category': 'Aging Stock (8-30 days)',
                    'Quality': item.quality,
                    'Unique Code': item.code || 'N/A',
                    'Lot Number': item.lotNumber || 'N/A',
                    'Days in Stock': item.daysInStock,
                    'Quantity (Dozens)': item.totalDozens,
                    'Value (₹)': calculateExpectedAmount(item)
                });
            });
            
            // Add old stock
            agingData.old.items.forEach(item => {
                exportData.push({
                    'Category': 'Old Stock (30+ days)',
                    'Quality': item.quality,
                    'Unique Code': item.code || 'N/A',
                    'Lot Number': item.lotNumber || 'N/A',
                    'Days in Stock': item.daysInStock,
                    'Quantity (Dozens)': item.totalDozens,
                    'Value (₹)': calculateExpectedAmount(item)
                });
            });
            
            return exportData;
        }
        
        // Download file helper function
        function downloadFile(data, fileName, type) {
            try {
                const blob = new Blob([data], { type: type });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Error downloading file. Please try again.', 'error');
            }
        }
        
        // Show download location info function
        function showDownloadHelp() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            let helpText = '';
            
            if (isMobile) {
                helpText = 'Check your device\'s Download folder or Files app to find the exported file. ' +
                           'On Android, look for the "Downloads" app. On iOS, check the "Files" app.';
            } else {
                helpText = 'File saved to your Downloads folder. ' +
                           'Press Ctrl+J (Windows) or Cmd+J (Mac) to quickly view downloads in your browser.';
            }
            
            showNotification(helpText, 'info', 6000);
        }
        
        // ================= NOTIFICATION FUNCTION =================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                  type === 'error' ? 'fa-exclamation-circle' : 
                                  type === 'warning' ? 'fa-exclamation-triangle' : 
                                  'fa-info-circle'}"></i>
                </div>
                <div class="notification-content">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after duration
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }
        
        // ================= UTILITY FUNCTIONS =================
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        // Initialize the page when loaded
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>